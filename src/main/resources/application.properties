# Spring Application Configuration
spring.application.name=blog-service

# Default profile: 'local' (PostgreSQL on rpi5 K3s)
# Use -Dspring-boot.run.profiles=dev for H2 in-memory database
spring.profiles.default=local

# === HashiCorp Vault (C1 Fix — secrets management) ===
# Vault import moved to profile-specific files (local/prod/cloud)
# to avoid bootstrap failures when Vault is unavailable (e.g., dev profile)
spring.cloud.vault.enabled=${VAULT_ENABLED:false}
spring.cloud.vault.uri=${VAULT_ADDR:http://192.168.1.193:30820}
spring.cloud.vault.authentication=APPROLE
spring.cloud.vault.app-role.role-id=${VAULT_ROLE_ID:}
spring.cloud.vault.app-role.secret-id=${VAULT_SECRET_ID:}
spring.cloud.vault.app-role.app-role-path=approle
spring.cloud.vault.kv.enabled=true
spring.cloud.vault.kv.backend=secret
spring.cloud.vault.kv.default-context=portfolio-blog
spring.cloud.vault.kv.application-name=portfolio-blog
spring.cloud.vault.fail-fast=false

# Server Configuration
server.port=8080
server.shutdown=graceful
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.enabled=true
server.servlet.encoding.force=true

# Internationalization - UTF-8 encoding for all message files
spring.messages.encoding=UTF-8
spring.messages.basename=messages

# R2DBC Configuration (Reactive Database)
spring.r2dbc.url=${DATABASE_URL:r2dbc:postgresql://localhost:5432/blog}
spring.r2dbc.username=${DATABASE_USERNAME:postgres}
spring.r2dbc.password=${DATABASE_PASSWORD:postgres}

# R2DBC Pool Configuration
# Flyway R2DBC schema versioning is planned but requires flyway-core + flyway-database-postgresql dependencies and a JDBC driver alongside R2DBC
# Pool sizing rationale: max-size=20 matches typical WebFlux concurrency on 4-core hosts;
# initial-size=10 warms half the pool at startup for fast first requests.
# Tune max-size based on (CPU cores * 2) + effective_spindle_count for PostgreSQL.
spring.r2dbc.pool.enabled=true

# Redis Configuration
spring.data.redis.host=${SPRING_DATA_REDIS_HOST:localhost}
spring.data.redis.port=${SPRING_DATA_REDIS_PORT:6379}
spring.data.redis.password=${SPRING_DATA_REDIS_PASSWORD:}
spring.cache.type=redis
spring.cache.redis.time-to-live=3600000
spring.cache.redis.cache-null-values=false
spring.data.redis.lettuce.pool.enabled=true
spring.data.redis.timeout=2000ms
spring.data.redis.connect-timeout=3000ms

# JWT Configuration
# REQUIRED: Set JWT_SECRET environment variable in production (min 256 bits / 32 chars)
jwt.secret=${JWT_SECRET}
# F-011: Access token TTL reduced from 24h to 30min (refresh token handles session continuity)
jwt.expiration=${JWT_EXPIRATION:1800000}

# JWT Cookie Security (default true for production; override to false in dev profile)
jwt.cookie.secure=${JWT_COOKIE_SECURE:true}
jwt.cookie.domain=${JWT_COOKIE_DOMAIN:}

# CORS Configuration
cors.allowed-origins=http://localhost:3000,http://127.0.0.1:3000,http://localhost:5500,http://127.0.0.1:5500,http://localhost:4200,http://127.0.0.1:4200
cors.allowed-methods=GET,POST,PUT,DELETE,PATCH,OPTIONS

# DeepL Translation API (Free tier: 500k chars/month)
# Get your key at: https://www.deepl.com/pro#developer
deepl.api-key=${DEEPL_API_KEY:}
deepl.use-pro=${DEEPL_USE_PRO:false}

# Logging
logging.level.root=INFO
logging.level.dev.catananti=INFO
logging.level.org.springframework.web=WARN
logging.level.org.springframework.r2dbc=WARN
logging.level.org.springframework.boot.context.config=WARN

# ==================== Actuator & Health Check ====================
# Exposed endpoints
management.endpoints.web.exposure.include=health,info,metrics,prometheus

# Health endpoint configuration
management.endpoint.health.show-details=when-authorized
management.endpoint.health.show-components=when-authorized
management.endpoint.health.probes.enabled=true
management.endpoint.health.probes.add-additional-paths=true

# Health groups for Kubernetes
management.endpoint.health.group.liveness.include=livenessState,ping
management.endpoint.health.group.readiness.include=readinessState,db,redis

# Slow health indicator warning threshold
management.endpoint.health.logging.slow-indicator-threshold=5s

# Health indicator configurations
management.health.db.enabled=true
management.health.redis.enabled=true
management.health.diskspace.enabled=true
management.health.ping.enabled=true
management.health.livenessstate.enabled=true
management.health.readinessstate.enabled=true

# Info endpoint
management.info.env.enabled=true
management.info.java.enabled=true
management.info.os.enabled=true
management.info.build.enabled=true

# Metrics
management.metrics.export.prometheus.enabled=true
management.metrics.tags.application=${spring.application.name}
management.metrics.distribution.percentiles-histogram.http.server.requests=true

# WebFlux Configuration
spring.webflux.base-path=/
spring.codec.max-in-memory-size=10MB

# File Upload (para imagens) - WebFlux uses codec configuration
# spring.servlet.multipart is not applicable for WebFlux
# Max file size is controlled by spring.codec.max-in-memory-size and ImageUploadService
spring.webflux.multipart.max-in-memory-size=256KB
spring.webflux.multipart.max-disk-usage-per-part=10MB

# ── Media Storage ──────────────────────────────
# Supported values: local (filesystem), s3 (MinIO / Cloudflare R2 / AWS S3)
app.storage.type=${STORAGE_TYPE:local}
app.upload.path=${UPLOAD_PATH:uploads}
app.upload.max-size=${UPLOAD_MAX_SIZE:10485760}

# S3-compatible storage (only used when app.storage.type=s3)
app.storage.s3.endpoint=${S3_ENDPOINT:http://localhost:9000}
app.storage.s3.region=${S3_REGION:us-east-1}
app.storage.s3.bucket=${S3_BUCKET:media}
app.storage.s3.access-key=${S3_ACCESS_KEY:minioadmin}
app.storage.s3.secret-key=${S3_SECRET_KEY:minioadmin}
app.storage.s3.public-url=${S3_PUBLIC_URL:http://localhost:9000/media}

# OpenAPI / Swagger
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.enabled=${SWAGGER_ENABLED:false}
springdoc.swagger-ui.operations-sorter=method
springdoc.swagger-ui.tags-sorter=alpha
springdoc.show-actuator=true

# App Info
app.version=2.0.0
app.name=Portfolio Blog API
app.description=RESTful API for Portfolio Blog
app.site-url=${APP_SITE_URL:http://localhost:4200}

# Refresh Token
jwt.refresh-expiration=604800000

# Response Compression
server.compression.enabled=true
server.compression.min-response-size=1024
server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json

# Graceful Shutdown
spring.lifecycle.timeout-per-shutdown-phase=30s

# Email Configuration (SMTP)
spring.mail.host=${MAIL_HOST:smtp.gmail.com}
spring.mail.port=${MAIL_PORT:587}
spring.mail.username=${MAIL_USERNAME:}
spring.mail.password=${MAIL_PASSWORD:}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
spring.mail.properties.mail.smtp.connectiontimeout=5000
spring.mail.properties.mail.smtp.timeout=5000
spring.mail.properties.mail.smtp.writetimeout=5000

# App Email Settings
app.email.from=${MAIL_FROM:noreply@localhost}
app.email.from-name=${MAIL_FROM_NAME:Portfolio Blog}
app.email.rate-limit-per-hour=${EMAIL_RATE_LIMIT_PER_HOUR:10}
app.email.default-locale=${EMAIL_DEFAULT_LOCALE:pt-BR}
app.email.support=${EMAIL_SUPPORT:support@catananti.dev}

# F-172: Thymeleaf — used only for email templates, NOT for web views
spring.thymeleaf.enabled=false
spring.thymeleaf.prefix=classpath:/templates/email/
spring.thymeleaf.suffix=.html
spring.thymeleaf.mode=HTML
spring.thymeleaf.encoding=UTF-8
spring.thymeleaf.check-template-location=false

app.contact.notification-email=${CONTACT_NOTIFICATION_EMAIL:noreply@localhost}
app.url=${APP_URL:http://localhost:8080}

# Admin User Initialization (set via environment variables)
admin.email=${ADMIN_EMAIL:}
admin.password=${ADMIN_PASSWORD:}
admin.name=${ADMIN_NAME:Administrator}

# Newsletter Configuration
newsletter.confirmation-expiration-hours=${NEWSLETTER_CONFIRMATION_EXPIRATION_HOURS:48}

# Security Configuration  
# Note: Password minimum length is enforced via @Size annotation in UserRequest (12 chars)

# CSRF Protection (double-submit cookie pattern)
security.csrf.enabled=${SECURITY_CSRF_ENABLED:true}

# Login Attempt Protection
security.login.max-attempts=${SECURITY_LOGIN_MAX_ATTEMPTS:5}
security.login.attempt-window-minutes=${SECURITY_LOGIN_ATTEMPT_WINDOW_MINUTES:15}
security.login.progressive-lockout-base-minutes=${SECURITY_LOGIN_LOCKOUT_BASE_MINUTES:5}

# Rate Limiting
rate-limit.authenticated=${RATE_LIMIT_AUTHENTICATED:100}
rate-limit.anonymous=${RATE_LIMIT_ANONYMOUS:30}
rate-limit.login=${RATE_LIMIT_LOGIN:10}
rate-limit.window-seconds=${RATE_LIMIT_WINDOW_SECONDS:60}

# Scheduled Tasks (in milliseconds unless cron)
scheduling.initial-delay-ms=${SCHEDULING_INITIAL_DELAY_MS:30000}
scheduling.refresh-token-cleanup-ms=${SCHEDULING_REFRESH_TOKEN_CLEANUP_MS:3600000}
scheduling.password-reset-cleanup-ms=${SCHEDULING_PASSWORD_RESET_CLEANUP_MS:21600000}
scheduling.metrics-update-ms=${SCHEDULING_METRICS_UPDATE_MS:60000}
scheduling.newsletter-cleanup-cron=${SCHEDULING_NEWSLETTER_CLEANUP_CRON:0 0 3 * * *}
app.scheduler.article-publish-rate=${ARTICLE_PUBLISH_RATE:60000}

# Search Configuration
# Enable PostgreSQL Full-Text Search (to_tsvector/plainto_tsquery) in production
app.search.use-fts=${SEARCH_USE_FTS:true}

# Resilience Configuration (timeouts and retries)
resilience.database.timeout-seconds=${RESILIENCE_DB_TIMEOUT:10}
resilience.database.retry-max-attempts=${RESILIENCE_DB_RETRY_MAX:3}
resilience.database.retry-min-backoff-ms=${RESILIENCE_DB_RETRY_MIN_BACKOFF:100}
resilience.database.retry-max-backoff-ms=${RESILIENCE_DB_RETRY_MAX_BACKOFF:1000}
resilience.redis.timeout-seconds=${RESILIENCE_REDIS_TIMEOUT:5}
resilience.external.timeout-seconds=${RESILIENCE_EXTERNAL_TIMEOUT:30}

# ==================== Java 25 Virtual Threads ====================
# Virtual threads enabled by default in Spring Boot 4.1 (no config needed)
# spring.threads.virtual.enabled=true

# ==================== Cache Warming Configuration ====================
cache.warming.enabled=${CACHE_WARMING_ENABLED:true}
cache.warming.startup-pages=${CACHE_WARMING_STARTUP_PAGES:3}
cache.warming.prefetch-delay-ms=${CACHE_WARMING_PREFETCH_DELAY_MS:100}
cache.warming.refresh-rate-ms=${CACHE_WARMING_REFRESH_RATE_MS:300000}

# ==================== Connection Pool Optimization ====================
# R2DBC Pool - optimized for high concurrency (overrides defaults above)
spring.r2dbc.pool.max-size=${DB_POOL_MAX_SIZE:20}
spring.r2dbc.pool.initial-size=${DB_POOL_INITIAL_SIZE:10}
spring.r2dbc.pool.max-idle-time=${DB_POOL_MAX_IDLE_TIME:30m}
spring.r2dbc.pool.max-acquire-time=${DB_POOL_MAX_ACQUIRE_TIME:3s}
spring.r2dbc.pool.max-create-connection-time=${DB_POOL_MAX_CREATE_TIME:5s}
spring.r2dbc.pool.max-life-time=${DB_POOL_MAX_LIFE_TIME:30m}
spring.r2dbc.pool.validation-depth=LOCAL

# Redis Pool - optimized for caching (overrides defaults above)
spring.data.redis.lettuce.pool.max-active=${REDIS_POOL_MAX_ACTIVE:20}
spring.data.redis.lettuce.pool.max-idle=${REDIS_POOL_MAX_IDLE:10}
spring.data.redis.lettuce.pool.min-idle=${REDIS_POOL_MIN_IDLE:5}
spring.data.redis.lettuce.pool.max-wait=${REDIS_POOL_MAX_WAIT:2000ms}
spring.data.redis.lettuce.pool.time-between-eviction-runs=${REDIS_POOL_EVICTION_INTERVAL:30s}

# ==================== HTTP Client Optimization ====================
spring.webflux.hiddenmethod.filter.enabled=false

# ==================== JSON Serialization Optimization ====================
# Note: Configured via JacksonConfig.java due to tools.jackson in Spring Boot 4.x
# spring.jackson.serialization.WRITE_DATES_AS_TIMESTAMPS=false
# spring.jackson.deserialization.FAIL_ON_UNKNOWN_PROPERTIES=false
# spring.jackson.default-property-inclusion=non_null
# spring.jackson.mapper.DEFAULT_VIEW_INCLUSION=true

# ==================== Async Configuration ====================
spring.task.execution.pool.core-size=${TASK_POOL_CORE_SIZE:8}
spring.task.execution.pool.max-size=${TASK_POOL_MAX_SIZE:32}
spring.task.execution.pool.queue-capacity=${TASK_POOL_QUEUE_CAPACITY:100}
spring.task.execution.thread-name-prefix=blog-async-

# ==================== Scheduling Configuration ====================
spring.task.scheduling.pool.size=${TASK_SCHEDULING_POOL_SIZE:4}
spring.task.scheduling.thread-name-prefix=blog-sched-

# ==================== Performance Monitoring ====================
management.metrics.distribution.slo.http.server.requests=50ms,100ms,200ms,500ms,1s,5s
management.metrics.distribution.percentiles.http.server.requests=0.5,0.9,0.95,0.99

# ==================== HTTP Cache Configuration ====================
cache.http.enabled=${HTTP_CACHE_ENABLED:true}
cache.http.public-max-age-seconds=${HTTP_CACHE_PUBLIC_MAX_AGE:300}
cache.http.private-max-age-seconds=${HTTP_CACHE_PRIVATE_MAX_AGE:60}

# ==================== Netty Optimization ====================
spring.reactor.netty.workerCount=${NETTY_WORKER_COUNT:0}
reactor.netty.ioWorkerCount=${REACTOR_IO_WORKER_COUNT:-1}

# ==================== Google reCAPTCHA v3 ====================
recaptcha.enabled=${RECAPTCHA_ENABLED:false}
recaptcha.site-key=${RECAPTCHA_SITE_KEY:}
recaptcha.secret-key=${RECAPTCHA_SECRET_KEY:}
recaptcha.score-threshold=${RECAPTCHA_SCORE_THRESHOLD:0.5}

# ==================== Cloudflare Email Routing ====================
cloudflare.api-token=${CF_API_TOKEN:}
cloudflare.zone-id=${CF_ZONE_ID:}
cloudflare.email-routing.domain=${CF_EMAIL_DOMAIN:catananti.dev}
cloudflare.email-routing.enabled=${CF_EMAIL_ROUTING_ENABLED:false}

# ==================== Sentry Error Tracking ====================
sentry.dsn=${SENTRY_DSN:}
sentry.traces-sample-rate=0.2
sentry.environment=${SENTRY_ENVIRONMENT:local}
sentry.release=${app.version}
sentry.send-default-pii=false
sentry.logging.minimum-event-level=error
sentry.logging.minimum-breadcrumb-level=info

# ==================== MFA / Two-Factor Authentication ====================
mfa.totp.issuer=${MFA_TOTP_ISSUER:Catananti Portfolio}
mfa.totp.digits=6
mfa.totp.period-seconds=30
mfa.email-otp.length=6
mfa.email-otp.expiration-minutes=10
mfa.encryption-key=${MFA_ENCRYPTION_KEY:}

# ==================== Observability ====================
management.tracing.enabled=false
management.observations.key-values.application=${spring.application.name}

# ==================== Datadog Metrics Export ====================
management.datadog.metrics.export.enabled=${DD_METRICS_ENABLED:false}
management.datadog.metrics.export.api-key=${DD_API_KEY:}
management.datadog.metrics.export.uri=${DD_METRICS_URI:https://api.us5.datadoghq.com}
management.datadog.metrics.export.step=${DD_METRICS_STEP:30s}
management.datadog.metrics.export.descriptions=true
